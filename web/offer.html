<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Data Festivus</title>
    <link rel="stylesheet" href="style.css" />
    <script type="text/javascript" src="script.js"></script>
</head>
<body>
<header>
    <h1>WebRTC for the Rest of Us</h1>
    <p>Because Mozilla and Google seem to think everyone wants to build their own video chat app.  But the rest of us don't care about that.</p>
</header>
<div id="main">
    <p>
        <span><a id="start" href="#">Start the connection</a></span>
        <input type="text" onclick="this.select()" id="offerer_data" class="hide"
            value="This box will contain the connection data.  Click start to continue." />
    </p>
    <p>
        <span><a id="respond" class="hide" href="respond.html" target="respond">Answer this connection</a></span>
    </p>
    <p>
        <span id="reply_message"></span>
        <input type="text" onclick="this.select()" id="reply_data"  class="hide"
            value="This box will receive the response data.  Copy the data from the other tab to get that data." />
    </p>
</div>
<script type="text/javascript">
    var main_div = document.getElementById('main');
    var start_link = document.getElementById('start');
    var offerer_data = document.getElementById('offerer_data');
    var respond_link = document.getElementById('respond');
    var reply_data = document.getElementById('reply_data');
    var reply_message = document.getElementById('reply_message');
    
    var offererConnection = new ConnectionModel('abcd');
    var offerer = null;

    var rec = document.createElement('div');
    
    var hide = function(el){
        el.setAttribute('class', 'hide');
    };
    var unhide = function(el){
        el.setAttribute('class', '');
    };
    
    start_link.addEventListener('click', function(e){
        hide(this);
        unhide(offerer_data);
        e.preventDefault();
        offerer = offererConnection.init('offeringplayer');
        offerer.setMessage(function(data){
            var msg = document.createElement('span');
            msg.textContent = "other: " + data;
            rec.appendChild(msg);
            rec.appendChild(document.createElement('br'));
        });
        unhide(respond_link);
    });
    respond_link.addEventListener('click', function(e){
        hide(this);
        unhide(reply_data);
    });
    reply_data.addEventListener('change', function(e){
        try {
            var data = JSON.parse(this.value);
            offererConnection.unserialize(this.value);
        } catch (err) {
            reply_message.textContent = "invalid data, try pasting again";
        }
    });

    var updateOfferer = function(conn){
        var data = conn.serialize();
        offerer_data.value = data;
        offerer_data.textContent = data;
    };
    offererConnection.onoffer = updateOfferer;
    
    offererConnection.onready = function(){
        while (main_div.firstChild){
            main_div.removeChild(main_div.firstChild);
        }
        var inp = document.createElement('input');
        inp.type = 'text';
        inp.setAttribute('placeholder', 'send a message');
        main_div.appendChild(inp);

        main_div.appendChild(rec);

        inp.onchange = function(){

            var msg = document.createElement('span');
            msg.textContent = "self: " + this.value;
            rec.appendChild(msg);
            rec.appendChild(document.createElement('br'));

            offerer.send(this.value);
            this.value = '';
        };
    };

</script>
</body>
</html>