<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Data Festivus</title>
    <link rel="stylesheet" href="style.css" />
    <script type="text/javascript" src="script.js"></script>
    <style rel="stylesheet" type="text/css">
    </style>
</head>
<body>
<header>
    <h1>WebRTC for the Rest of Us</h1>
    <p>Because Mozilla and Google seem to think everyone wants to build their own video chat app.  But the rest of us don't care about that.</p>
    <nav><ul class="inline">
        <li><a href="index.html">Main</a></li>
        <li><a href="manual.html">Manual</a></li>
        <li><a href="server.html">Server</a></li>
    </ul></nav>
</header>
<div id="main">
    <h2>Use a stateless webserver (still need IM):</h2>
    <ul class="inline section-select">
        <li data-section="init">Start a connection</li>
        <li data-section="resp">Answer a connection</li>
    </ul>
    <section data-section="init">
    <div class="rec">
        <form id="session_start">
            <label for="session_name">Matchmaking Name</label>
            <input type="text" id="session_name" name="session" required minlength="5"/>
            <input type="submit" value="Start Session" />
        </form>
    </div>
    </section>
    <section data-section="resp">
        <div class="rec">
            <form id="session_reply">
                <label for="session_name">Matchmaking Name</label>
                <input type="text" id="session_name" name="session" required minlength="5"/>
                <input type="submit" value="Start Session" />
            </form>
        </div>
    </section>
    <section id="city_chat" class="hide">
        
    </section>
</div>
<script type="text/javascript">
    
    var links = document.querySelectorAll('li[data-section]');
    var addClick = function(i){
        links.item(i).addEventListener('click', function(e){
            for (var j = 0; j < links.length; ++j){
                var selector = "section[data-section='" +
                    links.item(j).dataset['section'] + "']";
                var section = document.querySelector(selector);
                var link = links.item(j); 
                if (j != i){
                    link.classList.remove('selected');
                    section.classList.remove('selected');
                } else {
                    link.classList.add('selected');
                    section.classList.add('selected');
                }
            }
        });
    };
    for (var i = 0; i < links.length; ++i){
        addClick(i)
    }
    
    var main_div = document.getElementById('main');
    var city_chat = document.getElementById('city_chat');

    var recMessage = function (data) {
        var msg = document.createElement('span');
        msg.textContent = "other: " + data;
        city_chat.appendChild(msg);
        city_chat.appendChild(document.createElement('br'));
        unhide(reply_data);
    };

    var start_form = document.getElementById('session_start');
    start_form.addEventListener('submit', function(e){
        e.preventDefault();
        if (this.checkValidity()){
            var name = this.elements.namedItem('session').value;
            var poller = new Poller();
            poller.start(name);
        }
    });
    var reply_form = document.getElementById('session_reply');
    reply_form.addEventListener('submit', function(e){
        e.preventDefault();
        if (this.checkValidity()){
            var name = this.elements.namedItem('session').value;
            var poller = new Poller();
            poller.reply(name);
        }
    });
    
    var Poller = function(){
        this.name = null;
        this.connectionModel = null;
        this.rtc = null;
        var self = this;

        var pollTimeout;
        var pollXHR = function (conn, call, then) {
            var connJson = conn.serialize();
            var formData = new FormData();
            formData.append('call', call);
            formData.append('name', self.name);
            formData.append('connection', connJson);

            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'signal.php');
            xhr.onload = function(XHRe){
                try {
                    var data = JSON.parse(XHRe.target.response);
                } catch (e){
                    console.log('invalid server response.');
                    return;
                }
                if (data.result == 'success') {
                    then(data);
                } else {
                    alert('error talking to server');
                }
            };
            xhr.send(formData);
        };
        
        var sendMessageWire = function () {
            var inp = document.createElement('input');
            inp.type = 'text';
            inp.setAttribute('placeholder', 'send a message');
            city_chat.appendChild(inp);

            inp.onchange = function () {

                var msg = document.createElement('span');
                msg.textContent = "self: " + this.value;
                city_chat.appendChild(msg);
                city_chat.appendChild(document.createElement('br'));

                self.rtc.send(this.value);
                this.value = '';
            };
        };
        
        this.start = function(name){
            this.name = name;
            this.connectionModel = new ConnectionModel(name);
            var self = this;

            var poll = function(){
                pollXHR(self.connectionModel, 'fetch', function(data){
                    self.connectionModel.unserialize(
                            JSON.stringify(data.connection)
                    );
                    pollTimeout = setTimeout(poll, 750);
                });
            };
            
            this.connectionModel.onoffer = function(){
                // start polling after creating the offer 
                pollXHR(self.connectionModel, 'start', poll);
            };
            this.connectionModel.onicecandidate = function(conn){
                clearTimeout(pollTimeout);
                pollXHR(self.connectionModel, 'update', poll);
            };
            this.rtc = this.connectionModel.init();
            this.connectionModel.onready = function(){
                alert("waitwhat?");
                clearTimeout(pollTimeout);
                unhide(city_chat);
                self.rtc.onmessage = recMessage;
                sendMessageWire();
            };
            
        };
        
        this.reply = function(name){
            this.name = name;
            this.connectionModel = new ConnectionModel(name);

            var poll = function(){
                pollXHR(self.connectionModel, 'fetch', function(data){
                    self.connectionModel.unserialize(
                            JSON.stringify(data.connection)
                    );
                    pollTimeout = setTimeout(poll, 750);
                });
            };
            this.connectionModel.onanswer = function(){
                clearTimeout(pollTimeout);
                pollXHR(self.connectionModel, 'update', poll);
            };

            this.connectionModel.onicecandidate = function(conn){
                clearTimeout(pollTimeout);
                pollXHR(self.connectionModel, 'update', poll);
            };
            this.rtc = this.connectionModel.respond();
            this.connectionModel.onready = function(){
                clearTimeout(pollTimeout);
                unhide(city_chat);
                self.rtc.onmessage = recMessage;
                sendMessageWire();
            };
            
            //start polling immediately.
            poll();
        }
        
    };

</script>
</body>
</html>